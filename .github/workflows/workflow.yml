name: Daily Polyratings DB Dump

on:
    push:
        branches:
            - runner
    schedule:
        - cron: '0 0 * * *'

jobs:
    db-dumper:
        name: Polyratings Database Dumper
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repo
              uses: actions/checkout@v3
              with:
                  ref: 'runner'

            - name: Run Python Script
              run: 'python3 dump-professors.py'
              env:
                  POLYRATINGS_USERNAME: ${{ secrets.POLYRATINGS_USERNAME }}
                  POLYRATINGS_PASSWORD: ${{ secrets.POLYRATINGS_PASSWORD }}

            - name: Get Current Date
              id: date
              run: echo "::set-output name=date::$(date +'%Y-%m-%dT%H:%M:%SZ')"

            - name: Commit Generated Files
              run: |
                  git stash --include-untracked
                  git fetch
                  git checkout data
                  rm prof* || echo "Could not remove prof files, likely don't exist"
                  git stash pop
                  git add professor-dump.json professor-list.json
                  git config --global user.email "addison@atustin.dev"
                  git config --global user.name "Addison Tustin"
                  git commit -m "Upload new DB dump at ${{ steps.date.outputs.date }}"
                  git push origin data --force

